{% extends "base.html" %}
{% block title %}Requirements – {{ project.selected_venue }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="milestone-title">📋 Poster Requirements</h1>
            <p class="text-muted">For: <strong>{{ project.selected_venue }}</strong></p>
        </div>
    </div>

    <div class="row mb-3 justify-content-center">
        <div class="col-auto">
            <a href="{{ url_for('project.view', project_id=project.id) }}" class="btn btn-outline-secondary">
                ← Back to Project
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">

            {% if project.venue_requirements_data %}
            <!-- VIEW MODE -->
            <div id="req-view-card" class="card tracker-card p-4">
                <div class="card-body">
                    {% set reqs = project.venue_requirements_data %}

                    <div class="row mb-2">
                        <div class="col-md-5 text-muted">📅 Abstract Submission Due:</div>
                        <div class="col-md-7">{{ reqs.abstract_submission_due or "Not available" }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-5 text-muted">📦 Final Submission Due:</div>
                        <div class="col-md-7">{{ reqs.final_submission_due or "Not available" }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-5 text-muted">🕒 Poster Networking Hours:</div>
                        <div class="col-md-7">{{ reqs.poster_networking_hours or "Not available" }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-5 text-muted">🔗 Source URL:</div>
                        <div class="col-md-7">
                            {% if reqs.source_url %}
                            <a href="{{ reqs.source_url }}" target="_blank" class="text-decoration-none">
                                {{ reqs.source_url }}
                            </a>
                            {% else %}
                            <span class="text-muted">Not available</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mt-4 justify-content-center">
                        <div class="col-auto">
                            <button class="btn btn-outline-secondary" onclick="toggleEdit(true)">
                                ✏️ Edit Requirements
                            </button>
                        </div>

                        {% if current_user.plan != 'student' %}
                        <div class="col-auto">
                            <a href="{{ url_for('venue.regenerate_requirements', project_id=project.id, venue_name=project.selected_venue) }}"
                               class="btn btn-primary"
                               onclick="this.innerText='Regenerating...'; this.classList.add('disabled');">
                                🔁 Recreate with AI
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- EDIT MODE (Always rendered) -->
            <form method="POST" id="req-edit-card"
                  class="card tracker-card p-4 {% if project.venue_requirements_data %}d-none{% endif %}"
                  action="{{ url_for('venue.save_requirements', project_id=project.id, venue_name=project.selected_venue) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="card-body">
                    {% set reqs = project.venue_requirements_data or {} %}

                    <div class="row mb-3">
                        <div class="col-12">
                            <h3 class="card-title">✏️ {% if project.venue_requirements_data %}Edit{% else %}Add{% endif
                                %} Poster Requirements</h3>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-5 text-muted">
                            <label for="abstract_due" class="form-label">📅 Abstract Submission Due:</label>
                        </div>
                        <div class="col-md-7">
                            <input type="text" id="abstract_due" name="abstract_submission_due"
                                   class="form-control"
                                   value="{{ reqs.abstract_submission_due or '' }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 text-muted">
                            <label for="final_due" class="form-label">📦 Final Submission Due:</label>
                        </div>
                        <div class="col-md-7">
                            <input type="text" id="final_due" name="final_submission_due"
                                   class="form-control"
                                   value="{{ reqs.final_submission_due or '' }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 text-muted">
                            <label for="networking_hours" class="form-label">🕒 Poster Networking Hours:</label>
                        </div>
                        <div class="col-md-7">
                            <input type="text" id="networking_hours" name="poster_networking_hours"
                                   class="form-control"
                                   value="{{ reqs.poster_networking_hours or '' }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 text-muted">
                            <label for="source_url" class="form-label">🔗 Source URL:</label>
                        </div>
                        <div class="col-md-7">
                            <input type="url" id="source_url" name="source_url"
                                   class="form-control"
                                   value="{{ reqs.source_url or '' }}">
                        </div>
                    </div>

                    <div class="row mt-4 justify-content-center">
                        <div class="col-auto">
                            <button type="submit" class="btn btn-success">💾 Save</button>
                        </div>
                        <div class="col-auto">
                            {% if project.venue_requirements_data %}
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleEdit(false)">
                                ❌ Cancel
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleEdit(editing) {
        const viewCard = document.getElementById("req-view-card");
        const editCard = document.getElementById("req-edit-card");

        if (editing) {
            if (viewCard) viewCard.classList.add("d-none");
            editCard.classList.remove("d-none");
        } else {
            editCard.classList.add("d-none");
            if (viewCard) viewCard.classList.remove("d-none");
        }
    }
</script>
{% endblock %}