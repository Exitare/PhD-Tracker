{% extends "base.html" %}
{% block title %}Project Details - {{ project.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row">
    <h1 class="milestone-title mb-3 mb-md-0 text-center">{{ project.title }}</h1>
    <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary">← Back to Dashboard</a>
</div>

{% if error %}
<div class="alert alert-danger text-center mt-3">{{ error }}</div>
{% endif %}

<div class="card tracker-card p-4 mb-4">
    <div class="card-body">
        <h5 class="card-title">Description</h5>
        <p class="card-text">{{ project.description }}</p>
    </div>
</div>

{% if subprojects %}
<div class="container">
    <div class="row">
        {% for item in subprojects %}
        {% set sub = item.subproject %}
        {% set milestones = item.milestones %}

        <!-- Display Card -->
        <div class="col-12 mb-3" id="row-{{ sub.id }}">
            <div class="card tracker-card p-3 h-100">
                <div class="row">
                    <div class="col-md-9">
                        <h5 class="card-title">{{ sub.title }}</h5>
                        <p class="mb-1 text-muted">{{ sub.description }}</p>
                        <p class="mb-1"><strong>Created:</strong> {{ sub.created_at | datetimeformat }}</p>
                        <p class="mb-0"><strong>Milestones:</strong> {{ milestones | length if milestones else 0 }}</p>
                    </div>
                    <div class="col-md-3 d-flex flex-column gap-2 justify-content-start align-items-md-end mt-3 mt-md-0">
                        <a href="{{ url_for('subproject.view', project_id=sub.project_id, subproject_id=sub.id) }}"
                           class="btn w-100">
                            <i class="fas fa-eye"></i> View
                        </a>
                        <button class="btn btn-outline-secondary w-100" onclick="enableEdit({{ sub.id }})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <form method="POST"
                              action="{{ url_for('subproject.delete', project_id=sub.project_id, subproject_id=sub.id) }}"
                              onsubmit="return confirm('Are you sure you want to delete this subproject?');"
                              class="w-100">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Form Card -->
        <div class="col-12 mb-3" id="edit-row-{{ sub.id }}" style="display: none;">
            <div class="card tracker-card p-3 h-100">
                <form method="POST"
                      action="{{ url_for('subproject.edit', project_id=sub.project_id, subproject_id=sub.id) }}"
                      class="row g-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="col-md-4">
                        <input type="text" name="title" value="{{ sub.title }}" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <input type="text" name="description" value="{{ sub.description }}" class="form-control"
                               required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Save</button>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-secondary w-100"
                                onclick="cancelEdit({{ sub.id }})">Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="alert alert-info text-center mt-4">
    No subprojects found for this project.
</div>
{% endif %}

<div class="text-center mt-4">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse"
            data-bs-target="#addSubprojectForm">
        ➕ Add Subproject
    </button>
</div>

<div class="collapse mt-3" id="addSubprojectForm">
    <form id="subprojectForm" method="POST" action="{{ url_for('subproject.create', project_id=project.id) }}"
          class="card card-body tracker-card mt-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="mb-3">
            <label for="subproject-title" class="form-label">Subproject Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="subproject-title" name="title" required>
        </div>

        <div class="mb-3">
            <label for="subproject-description" class="form-label">Description <span
                    class="text-danger">*</span></label>
            <textarea class="form-control" id="subproject-description" name="description" rows="3" required></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Milestone Generation</label>
            {% if current_user.plan == "student_plus" %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="ai_option" id="ai_no" value="no" checked>
                <label class="form-check-label" for="ai_no">Create blank subproject</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="ai_option" id="ai_yes" value="yes">
                <label class="form-check-label" for="ai_yes">Use AI to generate milestones</label>
            </div>
            {% else %}
            <div class="alert alert-warning mt-2 mb-0">
                AI milestone generation is available for Student+ plans only.
            </div>
            <input type="hidden" name="ai_option" value="no">
            {% endif %}
        </div>

        <div class="mb-3">
            <label for="deadline" class="form-label">Deadline <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="deadline" name="deadline">
        </div>

        <button type="submit" class="btn btn-success" id="saveSubprojectBtn">Save Subproject</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById("subprojectForm").addEventListener("submit", function (e) {
        const title = document.getElementById("subproject-title").value.trim();
        const description = document.getElementById("subproject-description").value.trim();
        const deadline = document.getElementById("deadline").value.trim();
        const aiInputs = document.querySelectorAll('input[name="ai_option"]');
        const aiOption = document.querySelector('input[name="ai_option"]:checked');
        const submitBtn = document.getElementById("saveSubprojectBtn");

        if (!title || !description || !deadline) {
            e.preventDefault();
            alert("Please fill out all required fields: title, description, and deadline.");
            return;
        }

        if (aiInputs.length > 0 && aiInputs[0].offsetParent !== null && !aiOption) {
            e.preventDefault();
            alert("Please select a milestone generation option.");
            return;
        }

        submitBtn.disabled = true;

        if (aiOption && aiOption.value === "yes") {
            submitBtn.textContent = "Creating milestones & saving...";
        } else {
            submitBtn.textContent = "Saving...";
        }
    });

    function enableEdit(id) {
        document.getElementById(`row-${id}`).style.display = "none";
        document.getElementById(`edit-row-${id}`).style.display = "table-row";
    }

    function cancelEdit(id) {
        document.getElementById(`edit-row-${id}`).style.display = "none";
        document.getElementById(`row-${id}`).style.display = "table-row";
    }
</script>
{% endblock %}