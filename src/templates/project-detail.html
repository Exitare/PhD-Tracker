{% extends "base.html" %}

{% block title %}Project Details - {{ project.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row">
    <h1 class="milestone-title mb-3 mb-md-0 text-center">{{ project.title }}</h1>
    <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary">← Back to Dashboard</a>
</div>

<div class="card shadow tracker-card p-4 mb-4">
    <div class="card-body">
        <h5 class="card-title">Description</h5>
        <p class="card-text">{{ project.description }}</p>
    </div>
</div>

{% if subprojects %}
<div class="card shadow tracker-card p-4">
    <div class="table-responsive">
        <table class="table table-bordered table-hover bg-white">
            <thead class="table-light">
            <tr>
                <th>Subproject Title</th>
                <th>Description</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for sub in subprojects %}
            <tr>
                <td>{{ sub.title }}</td>
                <td>{{ sub.description }}</td>
                <td>{{ sub.created_at | datetimeformat }}</td>
                <td class="text-nowrap">
                    <a href="{{ url_for('subproject.view', subproject_id=sub.id) }}"
                       class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> View
                    </a>
                    <a href="{{ url_for('subproject.edit', subproject_id=sub.id) }}"
                       class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <form method="POST"
                          action="{{ url_for('subproject.delete', subproject_id=sub.id) }}"
                          class="d-inline"
                          onsubmit="return confirm('Are you sure you want to delete this subproject?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="alert alert-info text-center mt-4">
    No subprojects found for this project.
</div>
{% endif %}

<!-- ✅ Add Subproject Section -->
<div class="text-center mt-4">
    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse"
            data-bs-target="#addSubprojectForm">
        ➕ Add Subproject
    </button>
</div>

<div class="collapse mt-3" id="addSubprojectForm">
    <form method="POST" action="{{ url_for('project.add_subproject', project_id=project.id) }}"
          class="card card-body shadow-sm mt-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="mb-3">
            <label for="subproject-title" class="form-label">Subproject Title</label>
            <input type="text" class="form-control" id="subproject-title" name="title" required>
        </div>

        <div class="mb-3">
            <label for="subproject-description" class="form-label">Description</label>
            <textarea class="form-control" id="subproject-description" name="description" rows="3" required></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Milestone Generation</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="ai_option" id="ai_no" value="no" checked
                       onchange="toggleDeadline(false)">
                <label class="form-check-label" for="ai_no">Create blank subproject</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="ai_option" id="ai_yes" value="yes"
                       onchange="toggleDeadline(true)">
                <label class="form-check-label" for="ai_yes">Use AI to generate milestones</label>
            </div>
        </div>

        <div class="mb-3" id="deadline-group" style="display: none;">
            <label for="deadline" class="form-label">Deadline (optional)</label>
            <input type="date" class="form-control" id="deadline" name="deadline">
        </div>

        <button type="submit" class="btn btn-success">Save Subproject</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleDeadline(show) {
        document.getElementById("deadline-group").style.display = show ? "block" : "none";
    }
</script>
{% endblock %}